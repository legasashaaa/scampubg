from telethon import TelegramClient
from telethon.sessions import StringSession
import asyncio
import os

async def create_and_save_session():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª"""
    
    # –ü–æ–ª—É—á–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ https://my.telegram.org
    API_ID = 1234567  # –í–∞—à API ID
    API_HASH = '–≤–∞—à_api_hash'  # –í–∞—à API Hash
    
    # –ò–º—è –¥–ª—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏
    session_name = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏ (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è): ").strip()
    if not session_name:
        session_name = "my_session"
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª .session
    session_file = f"{session_name}.session"
    
    print(f"\n–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ —Ñ–∞–π–ª–µ: {session_file}")
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–µ—Å—Å–∏–µ–π
    client = TelegramClient(session_file, API_ID, API_HASH)
    
    await client.connect()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if not await client.is_user_authorized():
        print("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...")
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        phone = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä +79991234567): ").strip()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–¥
        await client.send_code_request(phone)
        print("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!")
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥
        code = input("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥: ").strip()
        
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —Å –∫–æ–¥–æ–º
            await client.sign_in(phone=phone, code=code)
        except Exception as e:
            # –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å (2FA)
            if "password" in str(e).lower():
                print("–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.")
                password = input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA: ")
                await client.sign_in(password=password)
            else:
                raise e
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
    me = await client.get_me()
    print(f"\n‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
    print(f"–ò–º—è: {me.first_name}")
    print(f"–§–∞–º–∏–ª–∏—è: {me.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}")
    print(f"Username: @{me.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
    print(f"ID: {me.id}")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    session_string = client.session.save()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É —Å–µ—Å—Å–∏–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    with open(f"{session_name}_string.txt", "w", encoding="utf-8") as f:
        f.write(session_string)
    
    print(f"\nüìÅ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª—ã:")
    print(f"1. {session_file} (–±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏)")
    print(f"2. {session_name}_string.txt (—Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ)")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...")
    async for dialog in client.iter_dialogs(limit=3):
        print(f"  - {dialog.name} ({dialog.id})")
    
    await client.disconnect()
    print("\n‚úÖ –ì–æ—Ç–æ–≤–æ! –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.")

async def load_session_from_file():
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Å—Å–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
    
    API_ID = 1234567
    API_HASH = '–≤–∞—à_api_hash'
    
    # –ò—â–µ–º —Ñ–∞–π–ª—ã .session
    session_files = [f for f in os.listdir('.') if f.endswith('.session')]
    
    if not session_files:
        print("–§–∞–π–ª—ã —Å–µ—Å—Å–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return None
    
    print("\n–ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å–µ—Å—Å–∏–π:")
    for i, file in enumerate(session_files, 1):
        print(f"{i}. {file}")
    
    choice = input(f"\n–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (1-{len(session_files)}): ").strip()
    
    try:
        idx = int(choice) - 1
        session_file = session_files[idx]
    except (ValueError, IndexError):
        session_file = input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏: ").strip()
        if not session_file.endswith('.session'):
            session_file += '.session'
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ—Å—Å–∏—é
    client = TelegramClient(session_file, API_ID, API_HASH)
    await client.connect()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if await client.is_user_authorized():
        me = await client.get_me()
        print(f"\n‚úÖ –°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        print(f"–ê–∫–∫–∞—É–Ω—Ç: {me.first_name} (@{me.username})")
        return client
    else:
        print("‚ùå –°–µ—Å—Å–∏—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞!")
        await client.disconnect()
        return None

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("=" * 50)
    print("TELEGRAM SESSION MANAGER")
    print("=" * 50)
    
    while True:
        print("\n–ú–µ–Ω—é:")
        print("1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª")
        print("2. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é –∏–∑ —Ñ–∞–π–ª–∞")
        print("3. –í—ã—Ö–æ–¥")
        
        choice = input("\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1-3): ").strip()
        
        if choice == '1':
            await create_and_save_session()
        elif choice == '2':
            client = await load_session_from_file()
            if client:
                # –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏
                print("\n–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?")
                print("1. –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ")
                print("2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∏")
                print("3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
                
                action = input("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ").strip()
                
                if action == '1':
                    me = await client.get_me()
                    print(f"\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ:")
                    print(f"ID: {me.id}")
                    print(f"–ò–º—è: {me.first_name}")
                    print(f"–§–∞–º–∏–ª–∏—è: {me.last_name or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}")
                    print(f"Username: @{me.username or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
                    print(f"–¢–µ–ª–µ—Ñ–æ–Ω: {me.phone or '–ù–µ —É–∫–∞–∑–∞–Ω'}")
                
                elif action == '2':
                    limit = input("–°–∫–æ–ª—å–∫–æ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å? (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10): ").strip()
                    limit = int(limit) if limit.isdigit() else 10
                    
                    print(f"\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ {limit} –¥–∏–∞–ª–æ–≥–æ–≤:")
                    async for dialog in client.iter_dialogs(limit=limit):
                        print(f"  - {dialog.name} (ID: {dialog.id})")
                
                elif action == '3':
                    phone_or_username = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ username –ø–æ–ª—É—á–∞—Ç–µ–ª—è: ").strip()
                    message = input("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ").strip()
                    
                    try:
                        await client.send_message(phone_or_username, message)
                        print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
                    except Exception as e:
                        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
                
                await client.disconnect()
        elif choice == '3':
            print("–í—ã—Ö–æ–¥...")
            break
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")

if __name__ == "__main__":
    asyncio.run(main())
